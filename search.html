<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HBIM Tachara — Search avanzata</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:1rem;line-height:1.45}
.controls{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin-bottom:.5rem}
fieldset{border:1px solid #ddd;border-radius:.4rem;padding:.4rem .6rem}
legend{font-size:.9em;color:#444}
input,button{padding:.45rem .6rem;border:1px solid #bbb;border-radius:.4rem}
table{border-collapse:collapse;width:100%;margin-top:1rem}
th,td{border:1px solid #ddd;padding:.5rem;vertical-align:top}
th{background:#f7f7f7;text-align:left}
.badge{background:#eee;border-radius:.4rem;padding:.15rem .4rem;margin-left:.4rem;font-size:.9em}
#status{margin-left:.8rem;color:#444}
small{color:#666}
.err{color:#900;background:#fee;border:1px solid #f88;padding:.35rem .6rem;border-radius:.4rem;margin-left:.6rem}
</style>
</head>
<body>
<h1>HBIM Tachara — Search avanzata</h1>

<div class="controls">
  <input id="q" size="26" placeholder="Testo (label/name/foto)">
  <input id="phot" size="16" placeholder="Fotografo (es. Andreucci)">
  <input id="year" size="8" placeholder="Anno (es. 1966)">
  <input id="photoid" size="14" placeholder="Photo ID (prioritario)">
  <fieldset>
    <legend>Attività</legend>
    <label><input type="checkbox" id="act_rest"> Restauro</label>
    <label><input type="checkbox" id="act_exc"> Scavo</label>
    <label><input type="checkbox" id="act_spa"> Spoliazione tentata</label>
    <label><input type="checkbox" id="act_sps"> Spoliazione riuscita</label>
    <label><input type="checkbox" id="act_reu"> Reimpiego</label>
    <label><input type="checkbox" id="act_rel"> Ricollocazione</label>
  </fieldset>
  <button id="btnReset">Reset</button>
  <span id="status">carico…</span>
</div>
<small>Puoi combinare i filtri. Se compili <b>Photo ID</b>, il sistema mostra direttamente i GUID collegati a quella foto.</small>

<table id="tbl" hidden>
  <thead>
    <tr>
      <th>GUID</th>
      <th>Label / Name</th>
      <th>Foto (#)</th>
      <th>Collections</th>
      <th>IIIF</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const statusEl = document.getElementById('status');
const qInp     = document.getElementById('q');
const photInp  = document.getElementById('phot');
const yearInp  = document.getElementById('year');
const pidInp   = document.getElementById('photoid');
const tbl = document.getElementById('tbl'); const tbody = tbl.querySelector('tbody');

const act = {
  rest: document.getElementById('act_rest'),
  exc:  document.getElementById('act_exc'),
  spa:  document.getElementById('act_spa'),
  sps:  document.getElementById('act_sps'),
  reu:  document.getElementById('act_reu'),
  rel:  document.getElementById('act_rel'),
};

function esc(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

function parseCSV(text){
  if(!text) return [];
  const rows = text.split(/\r?\n/).filter(Boolean);
  if(!rows.length) return [];
  const head = rows.shift().split(',').map(s=>s.trim());
  return rows.map(line=>{
    const cells = line.split(','); const o={};
    head.forEach((h,i)=> o[h]= (cells[i]||'').trim());
    return o;
  });
}

function matchesYear(photo, Y){
  if(!Y) return true;
  const y1 = photo.year_start? parseInt(photo.year_start): null;
  const y2 = photo.year_end?   parseInt(photo.year_end):   null;
  if(y1 && y2) return y1<=Y && y2>=Y;
  if(y1 && !y2) return y1<=Y;
  if(!y1 && y2) return y2>=Y;
  return false;
}

let DATA=null, collMap=new Map(), iiifMap=new Map(), counts={};

async function safeFetchText(url){
  try{ const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error(r.status); return await r.text(); }
  catch{ return null; }
}

async function loadAll(){
  // prova viewer_data_full.json, poi viewer_data.json
  let txt = await safeFetchText('viewer_data_full.json');
  if(!txt) txt = await safeFetchText('viewer_data.json');
  if(!txt){ statusEl.innerHTML='<span class="err">viewer_data(_full).json non trovato</span>'; return; }
  DATA = JSON.parse(txt);

  const c = await safeFetchText('collections_map.csv');
  const m = await safeFetchText('manifests_map.csv');
  parseCSV(c).forEach(r=> collMap.set((r.ifc_guid||"").trim(), (r.collection_url||"").trim()));
  parseCSV(m).forEach(r=> iiifMap.set((r.ifc_guid||"").trim(), (r.manifest_url||"").trim()));

  counts.guids = Object.keys(DATA.guids||{}).length;
  counts.photos = Object.keys(DATA.photo_index||{}).length;
  counts.collections = collMap.size; counts.manifests=iiifMap.size;
  statusEl.textContent = `pronto — guids:${counts.guids} | photo_index:${counts.photos} | collections_map:${counts.collections} | manifests_map:${counts.manifests}`;
}

function filterByActivities(entry){
  const a = entry.activities || {};
  if (act.rest.checked && !a.restoration) return false;
  if (act.exc.checked  && !a.excavation)  return false;
  if (act.spa.checked  && !a.spolia tion_attempt) return false;
  if (act.sps.checked  && !a.spolia tion_success) return false;
  if (act.reu.checked  && !(a.reused_at || a.reused_coords)) return false;
  if (act.rel.checked  && !(a.relocated_back_year || a.relocated_by)) return false;
  return true;
}

function search(){
  if(!DATA?.guids) return;

  // Priorità: Photo ID → restituisce i suoi GUID direttamente
  const pid = (pidInp.value||'').trim();
  if (pid && DATA.photo_index && DATA.photo_index[pid]) {
    renderRows(DATA.photo_index[pid].map(g=>({guid:g, entry:DATA.guids[g]})));
    return;
  }

  const term  = (qInp.value||'').trim().toLowerCase();
  const pterm = (photInp.value||'').trim().toLowerCase();
  const yTxt  = (yearInp.value||'').trim();
  const Y = yTxt? parseInt(yTxt): null;

  const rows=[];
  for (const [guid, entry] of Object.entries(DATA.guids)) {
    const hay = JSON.stringify(entry).toLowerCase();
    if (term && !hay.includes(term)) continue;
    if (!filterByActivities(entry)) continue;

    const photos = entry.photos || [];
    let ok = true;
    if (pterm) ok = photos.some(ph => (ph.photographer||'').toLowerCase().includes(pterm));
    if (ok && Y) ok = photos.some(ph => matchesYear(ph, Y));
    if (!ok) continue;

    rows.push({guid, entry});
  }
  renderRows(rows);
}

function linkOrGuess(map, guid, sub){
  const url = map.get(guid) || (`./${sub}/${guid}.${sub==="collections"?"html":"json"}`);
  return `<a href="${url}" target="_blank" rel="noopener">open</a>`;
}

function renderRows(rows){
  rows.sort((a,b)=>{
    const na=(a.entry.photos||[]).length, nb=(b.entry.photos||[]).length;
    return (nb-na) || a.guid.localeCompare(b.guid);
  });
  tbody.innerHTML='';
  for (const {guid, entry} of rows.slice(0,1000)){
    const n=(entry.photos||[]).length, label= entry.label || entry.name_suggested || '';
    const coll = linkOrGuess(collMap, guid, "collections");
    const iiif = linkOrGuess(iiifMap, guid, "manifests");
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><code>${guid}</code></td>
      <td>${esc(label)} ${n? `<span class="badge">${n} foto</span>`:''}</td>
      <td>${n}</td>
      <td>${coll}</td>
      <td>${iiif}</td>`;
    tbody.appendChild(tr);
  }
  tbl.hidden = rows.length===0;
}

document.getElementById('btnReset').addEventListener('click', ()=>{
  qInp.value=''; photInp.value=''; yearInp.value=''; pidInp.value='';
  for(const k in act) act[k].checked=false;
  search();
});

[qInp, photInp, yearInp, pidInp, ...Object.values(act)].forEach(el=>{
  el.addEventListener('input', search);
});

loadAll().then(search);
</script>
</body>
</html>

