<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HBIM Tachara — Search avanzata</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:1rem;line-height:1.45}
.controls{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin-bottom:.5rem}
input,button{padding:.45rem .6rem;border:1px solid #bbb;border-radius:.4rem}
fieldset{border:1px solid #ddd;border-radius:.4rem;padding:.4rem .6rem}
legend{font-size:.9em;color:#444}
table{border-collapse:collapse;width:100%;margin-top:1rem}
th,td{border:1px solid #ddd;padding:.5rem;vertical-align:top}
th{background:#f7f7f7;text-align:left}
.badge{background:#eee;border-radius:.4rem;padding:.15rem .4rem;margin-left:.4rem;font-size:.9em}
#status{margin-left:.8rem;color:#444}
.err{color:#900;background:#fee;border:1px solid #f88;padding:.35rem .6rem;border-radius:.4rem;white-space:pre-wrap}
small{color:#666}
</style>
</head>
<body>
<h1>HBIM Tachara — Search avanzata</h1>

<div class="controls">
  <input id="q" size="26" placeholder="Testo (label/name/foto)">
  <input id="phot" size="16" placeholder="Fotografo (es. Andreucci)">
  <input id="year" size="8" placeholder="Anno (es. 1966)">
  <input id="photoid" size="14" placeholder="Photo ID (prioritario)">
  <fieldset>
    <legend>Attività</legend>
    <label><input type="checkbox" id="act_rest"> Restauro</label>
    <label><input type="checkbox" id="act_exc"> Scavo</label>
    <label><input type="checkbox" id="act_spa"> Spoliazione tentata</label>
    <label><input type="checkbox" id="act_sps"> Spoliazione riuscita</label>
    <label><input type="checkbox" id="act_reu"> Reimpiego</label>
    <label><input type="checkbox" id="act_rel"> Ricollocazione</label>
  </fieldset>
  <button id="btnReset">Reset</button>
  <span id="status">carico…</span>
</div>
<div id="diag" class="err" style="display:none"></div>
<small>Se compili <b>Photo ID</b>, mostra direttamente i GUID collegati a quella foto. I link si attivano se esistono le pagine/manifest.</small>

<table id="tbl" hidden>
  <thead>
    <tr><th>GUID</th><th>Label / Name</th><th>Foto (#)</th><th>Collections</th><th>IIIF</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const S = id=>document.getElementById(id);
const statusEl=S('status'), diag=S('diag'), tbl=S('tbl'), tbody=tbl.querySelector('tbody');
const q=S('q'), phot=S('phot'), year=S('year'), pid=S('photoid');
const act={rest:S('act_rest'),exc:S('act_exc'),spa:S('act_spa'),sps:S('act_sps'),reu:S('act_reu'),rel:S('act_rel')};

const esc=s=>(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
async function getText(url){
  try{const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error(url+" → "+r.status); return await r.text();}
  catch(e){return {__err:e.message||String(e)};}
}
function parseCSV(t){if(!t||t.__err)return[];const a=t.split(/\r?\n/).filter(Boolean);if(!a.length)return[];const h=a.shift().split(',').map(s=>s.trim());return a.map(line=>{const c=line.split(',');const o={};h.forEach((k,i)=>o[k]=(c[i]||'').trim());return o;});}
function matchesYear(ph,Y){if(!Y)return true; const y1=ph.year_start?parseInt(ph.year_start):null, y2=ph.year_end?parseInt(ph.year_end):null;
  if(y1&&y2) return y1<=Y&&y2>=Y; if(y1&&!y2) return y1<=Y; if(!y1&&y2) return y2>=Y; return false;}

let DATA=null, collMap=new Map(), iiifMap=new Map();

function showDiag(msg){diag.style.display='block'; diag.textContent=msg;}

async function loadAll(){
  let j = await getText('viewer_data_full.json');
  if(j.__err){ j = await getText('viewer_data.json'); }
  if(j.__err){ showDiag("Manca il JSON in root.\nCarica almeno uno tra:\n• viewer_data_full.json\n• viewer_data.json\nDettaglio: "+j.__err); return; }
  try{ DATA = JSON.parse(j); }catch(e){ showDiag("viewer_data(_full).json non è JSON valido."); return; }

  const c = await getText('collections_map.csv');
  const m = await getText('manifests_map.csv');
  if(!c.__err){ parseCSV(c).forEach(r=> collMap.set((r.ifc_guid||'').trim(), (r.collection_url||'').trim())); }
  if(!m.__err){ parseCSV(m).forEach(r=> iiifMap.set((r.ifc_guid||'').trim(), (r.manifest_url||'').trim())); }

  statusEl.textContent=`pronto — guids:${Object.keys(DATA.guids||{}).length} | photo_index:${Object.keys(DATA.photo_index||{}).length} | collections_map:${collMap.size} | manifests_map:${iiifMap.size}`;
}

function filterAct(entry){
  const a=entry.activities||{};
  if(act.rest.checked && !a.restoration) return false;
  if(act.exc.checked  && !a.excavation)  return false;
  if(act.spa.checked  && !a.spoliation_attempt) return false;   // ✅ corretto
  if(act.sps.checked  && !a.spoliation_success) return false;   // ✅ corretto
  if(act.reu.checked  && !(a.reused_at||a.reused_coords)) return false;
  if(act.rel.checked  && !(a.relocated_back_year||a.relocated_by)) return false;
  return true;
}

function linkOrGuess(map,g,sub){
  const u = map.get(g) || (`${sub}/${g}.${sub==='collections'?'html':'json'}`);
  return `<a href="${u}" target="_blank" rel="noopener">open</a>`;
}

function render(rows){
  rows.sort((A,B)=> ( (B.entry.photos||[]).length - (A.entry.photos||[]).length ) || A.guid.localeCompare(B.guid));
  tbody.innerHTML='';
  rows.slice(0,1000).forEach(({guid,entry})=>{
    const n=(entry.photos||[]).length, label=entry.label||entry.name_suggested||'';
    const coll=linkOrGuess(collMap,guid,'collections');
    const iiif=linkOrGuess(iiifMap,guid,'manifests');
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><code>${guid}</code></td><td>${esc(label)} ${n?`<span class="badge">${n} foto</span>`:''}</td><td>${n}</td><td>${coll}</td><td>${iiif}</td>`;
    tbody.appendChild(tr);
  });
  tbl.hidden = rows.length===0;
}

function search(){
  if(!DATA?.guids) return;

  // Priority: Photo ID
  const pid = (document.getElementById('photoid').value||'').trim();
  if(pid && DATA.photo_index && DATA.photo_index[pid]){
    render(DATA.photo_index[pid].map(g=>({guid:g, entry:DATA.guids[g]})));
    return;
  }

  const term=(q.value||'').toLowerCase().trim();
  const pterm=(phot.value||'').toLowerCase().trim();
  const Ytxt=(year.value||'').trim(); const Y=Ytxt?parseInt(Ytxt):null;

  const rows=[];
  for(const [guid,entry] of Object.entries(DATA.guids)){
    const hay = JSON.stringify(entry).toLowerCase();
    if(term && !hay.includes(term)) continue;
    if(!filterAct(entry)) continue;

    const photos=entry.photos||[];
    let ok=true;
    if(pterm) ok = photos.some(ph => (ph.photographer||'').toLowerCase().includes(pterm));
    if(ok && Y) ok = photos.some(ph => matchesYear(ph,Y));
    if(!ok) continue;

    rows.push({guid,entry});
  }
  render(rows);
}

document.getElementById('btnReset').addEventListener('click', ()=>{
  q.value=''; phot.value=''; year.value=''; document.getElementById('photoid').value='';
  Object.values(act).forEach(x=>x.checked=false); search();
});
[q,phot,year,document.getElementById('photoid'),...Object.values(act)].forEach(el=> el.addEventListener('input', search));

loadAll().then(search);
</script>
</body>
</html>
