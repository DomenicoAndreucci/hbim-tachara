<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HBIM Tachara — Search</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:1rem;line-height:1.45}
input{padding:.5rem .6rem;border:1px solid #bbb;border-radius:.4rem;width:320px}
table{border-collapse:collapse;width:100%;margin-top:1rem}
th,td{border:1px solid #ddd;padding:.5rem;vertical-align:top}
th{background:#f7f7f7;text-align:left}
.badge{background:#eee;border-radius:.4rem;padding:.15rem .4rem;margin-left:.3rem;font-size:.9em}
#status{margin-left:.8rem;color:#666}
</style>
</head>
<body>
<h1>HBIM Tachara — Search (fotografo/anno/testo)</h1>
<div>
  <input id="q" placeholder="Cerca es. 'Andreucci', '1966', 'Door'">
  <span id="status">idle</span>
</div>
<table id="tbl" hidden>
  <thead>
    <tr>
      <th>GUID</th>
      <th>Label / Name</th>
      <th>Foto (#)</th>
      <th>Collections</th>
      <th>IIIF</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const statusEl = document.getElementById('status');
const q = document.getElementById('q');
const tbl = document.getElementById('tbl');
const tbody = tbl.querySelector('tbody');

// Carica JSON e mappe (se presenti)
async function safeFetch(url){
  try{ const r=await fetch(url); if(!r.ok) throw new Error(r.status); return await r.text(); }
  catch{ return null; }
}
function csvToArray(text){
  if(!text) return [];
  const rows = text.split(/\r?\n/).filter(Boolean);
  const head = rows.shift().split(',').map(s=>s.trim());
  return rows.map(line=>{
    const cells = line.split(','); const o={};
    head.forEach((h,i)=> o[h]= (cells[i]||'').trim());
    return o;
  });
}
let DATA=null, collMap=new Map(), iiifMap=new Map();

async function loadAll(){
  statusEl.textContent='carico dati…';
  DATA = await fetch('viewer_data.json').then(r=>r.json());
  const c = await safeFetch('site/collections_map.csv');
  const m = await safeFetch('site/manifests/manifests_map.csv');
  csvToArray(c).forEach(r=> collMap.set(r.ifc_guid, r.collection_url));
  csvToArray(m).forEach(r=> iiifMap.set(r.ifc_guid, r.manifest_url));
  statusEl.textContent='pronto';
}
function search(){
  const term = (q.value||'').trim().toLowerCase();
  const out=[];
  for(const [guid, entry] of Object.entries(DATA.guids||{})){
    const hay = JSON.stringify(entry).toLowerCase();
    if(!term || hay.includes(term)){
      const label = entry.label || entry.name_suggested || '';
      const nPhotos = (entry.photos||[]).length;
      out.push({guid, label, nPhotos});
    }
  }
  out.sort((a,b)=> (b.nPhotos-a.nPhotos) || a.guid.localeCompare(b.guid));
  tbody.innerHTML='';
  for(const r of out.slice(0,500)){
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><code>${r.guid}</code></td>
      <td>${escapeHtml(r.label)} ${r.nPhotos? `<span class="badge">${r.nPhotos} foto</span>`:''}</td>
      <td>${r.nPhotos}</td>
      <td>${linkOrDash(collMap.get(r.guid))}</td>
      <td>${linkOrDash(iiifMap.get(r.guid))}</td>`;
    tbody.appendChild(tr);
  }
  tbl.hidden = out.length===0;
}
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function linkOrDash(url){ return url? `<a href="${url}" target="_blank" rel="noopener">open</a>`:'—'; }

q.addEventListener('input', search);
loadAll().then(search);
</script>
</body>
</html>
