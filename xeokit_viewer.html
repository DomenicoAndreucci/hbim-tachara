<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HBIM Tachara — xeokit (CDN)</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;display:grid;grid-template-rows:auto 1fr}
header{padding:.6rem 1rem;border-bottom:1px solid #ddd;display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
#c{width:100%;height:calc(100vh - 56px);background:#f7f7f7}
input,button{padding:.45rem .6rem;border:1px solid #bbb;border-radius:.4rem}
.badge{background:#eee;border-radius:.4rem;padding:.15rem .4rem;margin-left:.3rem}
#panel{position:absolute;top:10px;left:10px;background:#fff;border:1px solid #ccc;border-radius:.5rem;max-width:380px;max-height:60vh;overflow:auto;padding:.6rem;box-shadow:0 2px 12px rgba(0,0,0,.15)}
#panel h3{margin:.2rem 0 .4rem}
#panel ul{margin:0;padding-left:1rem}
#panel li{margin:.15rem 0}
#err{position:absolute;right:10px;top:10px;background:#fee;border:1px solid #f88;color:#900;padding:.6rem;border-radius:.5rem;max-width:520px;display:none;white-space:pre-wrap}
</style>
</head>
<body>
<header>
  <strong>HBIM Tachara — xeokit</strong>
  <label>IFC URL: <input id="ifcUrl" size="40" value="tachara_ready.ifc"></label>
  <label>Data JSON: <input id="jsonUrl" size="40" value="viewer_data.json"></label>
  <input id="q" size="24" placeholder="Search es. Andreucci / 1966 / Door"/>
  <button id="btnLoad">Load</button>
  <span id="st" class="badge">idle</span>
</header>
<div style="position:relative">
  <canvas id="c"></canvas>
  <div id="panel" hidden><h3>Results</h3><ul id="list"></ul></div>
  <div id="err"></div>
</div>

<!-- xeokit SDK (ES module) -->
<script type="module">
const err = (m)=>{const e=document.getElementById('err'); e.textContent=m; e.style.display='block'; console.error(m);};

let xeokit;
try{
  xeokit = await import("https://cdn.jsdelivr.net/npm/@xeokit/xeokit-sdk@2.6.25/dist/xeokit-sdk.min.es.js");
}catch(e){
  err("❌ Non riesco a caricare xeokit SDK dal CDN.\n"+(e?.message||e));
}

const canvas = document.getElementById("c");
const st = document.getElementById('st');
const q = document.getElementById('q');
const list = document.getElementById('list');
const panel = document.getElementById('panel');
const ifcInput = document.getElementById('ifcUrl');
const jsonInput = document.getElementById('jsonUrl');

let viewer, webIfc, model, dataJSON, guidIndex = {};

async function init(){
  if(!xeokit){return;}
  const {Viewer, WebIFCLoaderPlugin, NavCubePlugin, CameraControl} = xeokit;
  viewer = new Viewer({canvasId: "c", transparent: true});
  new NavCubePlugin(viewer, {canvasId: "c"});
  new CameraControl(viewer);

  // WASM (CDN): puoi sostituire con path locale ./wasm/ se preferisci
  webIfc = new WebIFCLoaderPlugin(viewer, {
    wasmPath: "https://cdn.jsdelivr.net/npm/web-ifc@0.0.44/"
  });

  // Drag&drop
  canvas.addEventListener("dragover",e=>{e.preventDefault();});
  canvas.addEventListener("drop", async e=>{
    e.preventDefault();
    const f = e.dataTransfer.files[0]; if(!f) return;
    st.textContent="loading IFC (drop)…";
    try{
      const buffer = await f.arrayBuffer();
      model = await webIfc.load({ data: buffer, edges: true });
      viewer.cameraFlight.flyTo(model);
      st.textContent="ready";
    }catch(ex){ err("❌ IFC (drop) load failed: "+(ex?.message||ex)); }
  });
}

async function loadAll(){
  if(!viewer){ err("Viewer non inizializzato"); return; }
  st.textContent="loading IFC…";
  try{
    const url = ifcInput.value || "tachara_ready.ifc";
    const res = await fetch(url); const ab = await res.arrayBuffer();
    model = await webIfc.load({ data: ab, edges: true });
    viewer.cameraFlight.flyTo(model);
  }catch(e){ err("❌ IFC load failed: "+(e?.message||e)); return; }

  st.textContent="loading data…";
  try{
    dataJSON = await fetch(jsonInput.value || "viewer_data.json").then(r=>r.json());
  }catch(e){ err("❌ Data JSON load failed: "+(e?.message||e)); return; }

  // Costruisco indice GUID -> Entity (MetaObject) per highlight
  guidIndex = {}; try{
    const scene = viewer.metaScene; // contiene i MetaObject con .id (GUID)
    scene.root.metaObjects.forEach(mo=>{
      guidIndex[mo.id] = mo; // id = IFC GUID
    });
  }catch(_){/* se non disponibile, la search evidenzierà 0 elementi */}
  st.textContent="ready";
  search(); // esecuzione iniziale
}

function search(){
  const term = (q.value||"").trim().toLowerCase();
  if(!dataJSON?.guids){ return; }
  const items = [];
  for(const [guid, entry] of Object.entries(dataJSON.guids)){
    const hay = JSON.stringify(entry).toLowerCase();
    if(!term || hay.includes(term)) items.push({guid, entry});
  }
  // lista
  list.innerHTML = "";
  for(const it of items.slice(0,200)){
    const label = it.entry.label || it.entry.name_suggested || "";
    const li = document.createElement("li");
    const a = document.createElement("a");
    a.textContent = (label? (label+" – "):"")+it.guid;
    a.href = `./collections/${it.guid}.html`; a.target="_blank";
    li.appendChild(a); list.appendChild(li);
  }
  panel.hidden = items.length===0;

  // evidenzia
  try{
    viewer.scene.setObjectsHighlighted(viewer.scene.objectIds, false);
    const ids = items.map(it=>it.guid).filter(g=>guidIndex[g]);
    viewer.scene.setObjectsHighlighted(ids, true);
  }catch(_){}
}

document.getElementById('btnLoad').addEventListener('click', loadAll);
q.addEventListener('input', search);

await init();
</script>
</body>
</html>

