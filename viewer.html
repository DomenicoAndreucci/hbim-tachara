<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HBIM Tachara — IFC.js Viewer (import maps)</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;display:grid;grid-template-rows:auto 1fr}
header{padding:.6rem 1rem;border-bottom:1px solid #ddd;display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
#container{width:100%;height:calc(100vh - 56px);background:#f7f7f7}
input,button{padding:.45rem .6rem;border:1px solid #bbb;border-radius:.4rem}
.badge{background:#eee;border-radius:.4rem;padding:.15rem .4rem;margin-left:.3rem}
#results{position:absolute;top:10px;left:10px;background:#fff;padding:.6rem;border:1px solid #ccc;border-radius:.5rem;max-width:380px;max-height:60vh;overflow:auto;box-shadow:0 2px 12px rgba(0,0,0,.15)}
#results h3{margin:.2rem 0 .4rem 0}
#results ul{margin:0;padding-left:1rem}
#results li{margin:.15rem 0}
#err{position:absolute;right:10px;top:10px;background:#fee;border:1px solid #f88;color:#900;padding:.6rem;border-radius:.5rem;max-width:520px;display:none;white-space:pre-wrap}
</style>

<!--  Import map: dice al browser da che URL caricare le dipendenze ESM  -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.module.js",
    "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.155.0/examples/jsm/",
    "web-ifc-three": "https://cdn.jsdelivr.net/npm/web-ifc-three@0.0.152/IFCLoader.js",
    "web-ifc-viewer": "https://cdn.jsdelivr.net/npm/web-ifc-viewer@1.0.218/dist/index.js"
  }
}
</script>
</head>
<body>
<header>
  <strong>HBIM Tachara — Ifc.js Viewer</strong>
  <label>IFC URL: <input id="ifcUrl" size="40" value="tachara_ready.ifc"></label>
  <label>Data JSON: <input id="jsonUrl" size="40" value="viewer_data.json"></label>
  <input id="q" size="24" placeholder="Search es. Andreucci / 1966 / Door"/>
  <button id="btnLoad">Load</button>
  <span id="status" class="badge">idle</span>
</header>

<div id="viewer">
  <div id="container">Drop an IFC here as fallback</div>
  <div id="results" hidden>
    <h3>Results</h3><ul id="list"></ul>
  </div>
  <div id="err"></div>
</div>

<script type="module">
const errBox = document.getElementById('err');
function showErr(msg){ errBox.textContent=msg; errBox.style.display='block'; console.error(msg); }

let IfcViewerAPI = null;
try {
  const mod = await import('web-ifc-viewer'); // grazie all'import map
  IfcViewerAPI = mod?.IfcViewerAPI || mod?.default || null;
} catch (e) {
  showErr("❌ Import fallito: non riesco a caricare 'web-ifc-viewer' dai CDN.\n" + (e?.message||e));
}

const container = document.getElementById('container');
const statusEl  = document.getElementById('status');
const ifcUrl    = document.getElementById('ifcUrl');
const jsonUrl   = document.getElementById('jsonUrl');
const q         = document.getElementById('q');
const results   = document.getElementById('results');
const list      = document.getElementById('list');

let viewer, model, guidToExpress = {};

async function setupViewer(){
  if(!IfcViewerAPI) return;
  try{
    viewer = new IfcViewerAPI({ container, backgroundColor: new Uint8Array([255,255,255]) });
    // WASM: opzione 1) CDN stabile:
    await viewer.IFC.setWasmPath("https://cdn.jsdelivr.net/npm/web-ifc@0.0.44/");
    // Opzione 2) locale: crea /wasm/web-ifc.wasm e usa await viewer.IFC.setWasmPath("./wasm/");

    viewer.axes.setAxes();
    viewer.grid.setGrid();
  }catch(e){
    showErr("❌ Inizializzazione IfcViewer fallita.\nErrore: "+(e?.message||e));
  }

  // Drag&Drop fallback
  container.addEventListener('dragover', e=>{e.preventDefault();});
  container.addEventListener('drop', async e=>{
    e.preventDefault();
    const f = e.dataTransfer.files[0];
    if(!f) return;
    statusEl.textContent = 'loading IFC (drop)...';
    try{
      model = await viewer.IFC.loadIfcFile(f);
      await postLoad();
    }catch(err){
      showErr("❌ IFC (drop) load failed: "+(err?.message||err));
    }
  });
}

async function postLoad(){
  await viewer.shadowDropper.renderShadow(model.modelID);
  statusEl.textContent = 'indexing GUIDs...';
  guidToExpress = {};
  const IfcProduct = 103090709;
  const ids = await viewer.IFC.getAllItemsOfType(model.modelID, IfcProduct, true);
  for (const id of ids) {
    const p = await viewer.IFC.getProperties(model.modelID, id, true, false);
    if (p?.GlobalId?.value) guidToExpress[p.GlobalId.value] = id;
  }
  statusEl.textContent = 'ready';
}

async function loadAll(){
  if(!viewer){ showErr("❌ Viewer non inizializzato."); return; }
  try{
    statusEl.textContent = 'loading IFC...';
    model = await viewer.IFC.loadIfcUrl(ifcUrl.value || 'tachara_ready.ifc');
    await postLoad();
  }catch(e){
    showErr("❌ IFC load failed: "+(e?.message||e)); return;
  }

  let data;
  try{
    statusEl.textContent = 'loading data...';
    data = await fetch(jsonUrl.value || 'viewer_data.json').then(r=>r.json());
  }catch(e){
    showErr("❌ Data JSON load failed: "+(e?.message||e)); return;
  }

  function search(){
    const term = (q.value||'').trim().toLowerCase();
    const matched = [];
    for(const [guid, entry] of Object.entries(data.guids||{})){
      const hay = JSON.stringify(entry).toLowerCase();
      if(!term || hay.includes(term)) matched.push({guid, entry});
    }
    const list = document.getElementById('list');
    list.innerHTML = '';
    for(const it of matched.slice(0,200)){
      const label = it.entry.label || it.entry.name_suggested || '';
      const li = document.createElement('li');
      const a  = document.createElement('a');
      a.textContent = (label? (label+' – '):'') + it.guid;
      a.href = `./collections/${it.guid}.html`;
      a.target = '_blank';
      li.appendChild(a);
      list.appendChild(li);
    }
    document.getElementById('results').hidden = matched.length===0;

    const express = matched.map(m=>guidToExpress[m.guid]).filter(Boolean);
    viewer.IFC.selector.unpickIfcItems();
    if(express.length) viewer.IFC.selector.pickIfcItemsByID(model.modelID, express, true);
  }

  document.getElementById('q').addEventListener('input', search);
  search();
}

document.getElementById('btnLoad').addEventListener('click', loadAll);
await setupViewer();
</script>
</body>
</html>
