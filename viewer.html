<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HBIM Tachara – Ifc.js Viewer (robust)</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;display:grid;grid-template-rows:auto 1fr}
header{padding:.6rem 1rem;border-bottom:1px solid #ddd;display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
#viewer{position:relative}
#container{width:100%;height:calc(100vh - 56px);background:#f7f7f7}
input,button{padding:.45rem .6rem;border:1px solid #bbb;border-radius:.4rem}
.badge{background:#eee;border-radius:.4rem;padding:.15rem .4rem;margin-left:.3rem}
#results{position:absolute;top:10px;left:10px;background:#fff;padding:.6rem;border:1px solid #ccc;border-radius:.5rem;max-width:380px;max-height:60vh;overflow:auto;box-shadow:0 2px 12px rgba(0,0,0,.15)}
#results h3{margin:.2rem 0 .4rem 0}
#results ul{margin:0;padding-left:1rem}
#results li{margin:.15rem 0}
code{background:#f3f3f3;padding:0 .25rem;border-radius:.25rem}
#err{position:absolute;right:10px;top:10px;background:#fee;border:1px solid #f88;color:#900;padding:.6rem;border-radius:.5rem;max-width:420px;display:none}
</style>
</head>
<body>
<header>
  <strong>HBIM Tachara – Ifc.js Viewer</strong>
  <label>IFC URL: <input id="ifcUrl" size="40" placeholder="tachara_ready.ifc"></label>
  <label>Data JSON: <input id="jsonUrl" size="40" placeholder="viewer_data.json"></label>
  <input id="q" size="24" placeholder="Search e.g. Andreucci / 1966 / Door"/>
  <button id="btnLoad">Load</button>
  <span id="status" class="badge">idle</span>
</header>
<div id="viewer">
  <div id="container">Drop an IFC here as fallback</div>
  <div id="results" hidden>
    <h3>Results</h3>
    <ul id="list"></ul>
  </div>
  <div id="err"></div>
</div>

<script type="module">
const errBox = document.getElementById('err');
function showErr(msg){ errBox.textContent=msg; errBox.style.display='block'; console.error(msg); }

let IfcViewerAPI;
try{
  ({ IfcViewerAPI } = await import("https://cdn.jsdelivr.net/npm/web-ifc-viewer@latest/dist/web-ifc-viewer.es.js"));
}catch(e1){
  try{
    ({ IfcViewerAPI } = await import("https://unpkg.com/web-ifc-viewer@latest/dist/web-ifc-viewer.es.js"));
  }catch(e2){
    showErr("Could not load web-ifc-viewer from CDNs. Error: "+(e2?.message||e1?.message));
  }
}

const container = document.getElementById('container');
const statusEl = document.getElementById('status');
const ifcUrl = document.getElementById('ifcUrl');
const jsonUrl = document.getElementById('jsonUrl');
const q = document.getElementById('q');
const results = document.getElementById('results');
const list = document.getElementById('list');

let viewer, model, guidToExpress = {};

async function setupViewer(){
  if(!IfcViewerAPI){ showErr("IfcViewerAPI not available."); return; }
  viewer = new IfcViewerAPI({ container, backgroundColor: new Uint8Array([255,255,255]) });
  try{ await viewer.IFC.setWasmPath("https://unpkg.com/web-ifc@latest/"); }catch(e){}
  viewer.axes.setAxes();
  viewer.grid.setGrid();

  // drag&drop fallback
  container.addEventListener('dragover', e=>{e.preventDefault();});
  container.addEventListener('drop', async e=>{
    e.preventDefault();
    const f = e.dataTransfer.files[0];
    if(!f) return;
    statusEl.textContent = 'loading IFC (drop)...';
    model = await viewer.IFC.loadIfcFile(f);
    await postLoad();
  });
}

async function postLoad(){
  await viewer.shadowDropper.renderShadow(model.modelID);
  statusEl.textContent = 'indexing GUIDs...';
  guidToExpress = {};
  const ids = await viewer.IFC.getAllItemsOfType(model.modelID, 103090709, true);
  for (const id of ids) {
    const p = await viewer.IFC.getProperties(model.modelID, id, true, false);
    if (p && p.GlobalId && p.GlobalId.value) guidToExpress[p.GlobalId.value] = id;
  }
  statusEl.textContent = 'ready';
}

async function loadAll(){
  try{
    statusEl.textContent = 'loading IFC...';
    model = await viewer.IFC.loadIfcUrl(ifcUrl.value || 'tachara_ready.ifc');
    await postLoad();
  }catch(e){
    showErr("IFC load failed: "+(e?.message||e)); return;
  }

  let data;
  try{
    statusEl.textContent = 'loading data...';
    data = await fetch(jsonUrl.value || 'viewer_data.json').then(r=>r.json());
  }catch(e){
    showErr("Data JSON load failed: "+(e?.message||e)); return;
  }

  function search(){
    const term = (q.value||'').trim().toLowerCase();
    const matched = [];
    for(const [guid, entry] of Object.entries(data.guids||{})){
      const hay = JSON.stringify(entry).toLowerCase();
      if(!term || hay.includes(term)) matched.push({guid, entry});
    }
    list.innerHTML = '';
    for(const it of matched.slice(0,200)){
      const label = it.entry.label || it.entry.name_suggested || '';
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.textContent = (label? (label+' – '):'') + it.guid;
      a.href = `./collections/${it.guid}.html`;
      a.target = '_blank';
      li.appendChild(a);
      list.appendChild(li);
    }
    results.hidden = matched.length===0;

    const express = matched.map(m=>guidToExpress[m.guid]).filter(Boolean);
    viewer.IFC.selector.unpickIfcItems();
    if(express.length) viewer.IFC.selector.pickIfcItemsByID(model.modelID, express, true);
  }

  q.addEventListener('input', search);
  search();
}

document.getElementById('btnLoad').addEventListener('click', loadAll);
ifcUrl.value = 'tachara_ready.ifc';
jsonUrl.value = 'viewer_data.json';

setupViewer();
</script>
</body>
</html>
