<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HBIM Tachara – Viewer</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;display:grid;grid-template-rows:auto 1fr}
header{padding:.6rem 1rem;border-bottom:1px solid #ddd;display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
#viewer{position:relative}
#container{width:100%;height:calc(100vh - 56px)}
input,button{padding:.45rem .6rem;border:1px solid #bbb;border-radius:.4rem}
.badge{background:#eee;border-radius:.4rem;padding:.15rem .4rem;margin-left:.3rem}
#results{position:absolute;top:10px;left:10px;background:#fff;padding:.6rem;border:1px solid #ccc;border-radius:.5rem;max-width:380px;max-height:60vh;overflow:auto;box-shadow:0 2px 12px rgba(0,0,0,.15)}
#results h3{margin:.2rem 0 .4rem 0}
#results ul{margin:0;padding-left:1rem}
#results li{margin:.15rem 0}
code{background:#f3f3f3;padding:0 .25rem;border-radius:.25rem}
</style>
</head>
<body>
<header>
  <strong>HBIM Tachara – Ifc.js Viewer</strong>
  <label>IFC URL: <input id="ifcUrl" size="40" placeholder="tachara_ready.ifc"></label>
  <label>Data JSON: <input id="jsonUrl" size="40" placeholder="viewer_data.json"></label>
  <input id="q" size="24" placeholder="Search e.g. 'Andreucci', '1966', 'Door'"/>
  <button id="btnLoad">Load</button>
  <span id="status" class="badge">idle</span>
</header>
<div id="viewer">
  <div id="container"></div>
  <div id="results" hidden>
    <h3>Results</h3>
    <ul id="list"></ul>
  </div>
</div>

<script type="module">
import { IfcViewerAPI } from "https://cdn.jsdelivr.net/npm/web-ifc-viewer@latest/dist/web-ifc-viewer.es.js";

const container = document.getElementById('container');
const viewer = new IfcViewerAPI({ container, backgroundColor: new Uint8Array([255,255,255]) });
viewer.axes.setAxes();
viewer.grid.setGrid();

const ifcUrl = document.getElementById('ifcUrl');
const jsonUrl = document.getElementById('jsonUrl');
const q = document.getElementById('q');
const status = document.getElementById('status');
const results = document.getElementById('results');
const list = document.getElementById('list');

async function load() {
  status.textContent = 'loading IFC...';
  const model = await viewer.IFC.loadIfcUrl(ifcUrl.value || 'tachara_ready.ifc');
  await viewer.shadowDropper.renderShadow(model.modelID);
  status.textContent = 'loading data...';
  const data = await fetch(jsonUrl.value || 'viewer_data.json').then(r=>r.json());

  // Build reverse index (guid -> expressID)
  status.textContent = 'indexing GUIDs...';
  const ids = await viewer.IFC.getAllItemsOfType(model.modelID, 103090709, true); // IfcProduct + children (generic)
  const guidToExpress = {};
  for (const id of ids) {
    const p = await viewer.IFC.getProperties(model.modelID, id, true, false);
    if (p && p.GlobalId && p.GlobalId.value) guidToExpress[p.GlobalId.value] = id;
  }
  status.textContent = 'ready';

  function search() {
    const term = (q.value || '').trim().toLowerCase();
    let matchedGuids = new Set();
    let items = [];
    const guids = data.guids || {};
    for (const [guid, entry] of Object.entries(guids)) {
      const hay = JSON.stringify(entry).toLowerCase();
      if (!term || hay.includes(term)) {
        matchedGuids.add(guid);
        items.push({ guid, entry });
      }
    }
    list.innerHTML = '';
    for (const it of items.slice(0,200)) {
      const label = it.entry.label || it.entry.name_suggested || '';
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.textContent = (label? (label+' – '):'') + it.guid;
      a.href = `./collections/${it.guid}.html`;
      a.target = '_blank';
      li.appendChild(a);
      list.appendChild(li);
    }
    results.hidden = items.length===0;

    // isolate
    const express = Array.from(matchedGuids).map(g=>guidToExpress[g]).filter(Boolean);
    viewer.IFC.selector.unpickIfcItems();
    viewer.IFC.selector.pickIfcItemsByID(model.modelID, express, true);
    viewer.IFC.cutPlane.removeAllCutPlanes();
    if (express.length>0) viewer.context.renderer.postProduction.active = true;
  }

  q.addEventListener('input', search);
  search();
}

document.getElementById('btnLoad').addEventListener('click', load);

// Defaults for convenience
ifcUrl.value = 'tachara_ready.ifc';
jsonUrl.value = 'viewer_data.json';
</script>
</body>
</html>
